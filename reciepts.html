<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PGC Receipt Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            background-color: #f3f4f6;
            color: #2c2b6f;
            font-family: 'Inter', sans-serif;
        }
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .drop-zone {
            transition: all 0.3s ease;
            border-color: #2c2b6f;
        }
        .drop-zone.dragover {
            background-color: rgba(225, 58, 39, 0.1);
            border-color: #e13a27;
        }
        .receipt-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .receipt-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        .toast {
            animation: slideIn 0.5s ease forwards;
            background-color: #e13a27;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        input:focus, select:focus, textarea:focus {
            border-color: #e13a27 !important;
            ring-color: #e13a27 !important;
        }
    </style>
</head>


<body class="min-h-screen flex flex-col">
    <header class="bg-[#2c2b6f] text-white py-4">
        
        <div class="container mx-auto px-4 flex items-center">
            <img src="logo.svg" alt="PGC Logo" class="h-10 mr-3">
            <h1 class="text-2xl font-bold"></h1>
        </div>

<div><img src="Stip.png">   </div>
<div><img src="STRIP.png"></div>
        <div>
    <img src="PHYSICS PORTAL.png">
</div>


    </header>

    <main class="container mx-auto px-4 py-8 flex-grow">
        <section class="mb-8">
            <div class="glass rounded-lg p-6 shadow-lg">
                <h2 class="text-xl font-semibold mb-4 text-[#2c2b6f]">Add New Receipt</h2>
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="w-full md:w-1/2">
                        <div class="drop-zone border-2 border-dashed rounded-lg p-4 text-center cursor-pointer" id="dropZone">
                            <p class="text-[#2c2b6f]">Drag & drop images or click to upload</p>
                            <input type="file" id="fileInput" accept="image/*" multiple class="hidden">
                            <button id="cameraButton" class="mt-2 bg-[#e13a27] text-white px-4 py-2 rounded hover:bg-[#c93022] transition">Take Photo</button>
                        </div>
                        <div id="imagePreview" class="mt-4 grid grid-cols-3 gap-2"></div>
                    </div>
                    <form id="receiptForm" class="w-full md:w-1/2">
                        <div class="mb-4">
                            <label for="title" class="block text-sm font-medium text-[#2c2b6f]">Receipt Title</label>
                            <input type="text" id="title" class="mt-1 block w-full rounded-md border-[#2c2b6f] shadow-sm focus:border-[#e13a27] focus:ring-[#e13a27] text-[#2c2b6f]" required>
                        </div>
                        <div class="mb-4">
                            <label for="date" class="block text-sm font-medium text-[#2c2b6f]">Date</label>
                            <input type="date" id="date" class="mt-1 block w-full rounded-md border-[#2c2b6f] shadow-sm focus:border-[#e13a27] focus:ring-[#e13a27] text-[#2c2b6f]" required>
                        </div>
                        <div class="mb-4">
                            <label for="category" class="block text-sm font-medium text-[#2c2b6f]">Category</label>
                            <select id="category" class="mt-1 block w-full rounded-md border-[#2c2b6f] shadow-sm focus:border-[#e13a27] focus:ring-[#e13a27] text-[#2c2b6f]" required>
                                <option value="Lab Equipment">Lab Equipment</option>
                                <option value="Stationery">Stationery</option>
                                <option value="Maintenance">Maintenance</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="remarks" class="block text-sm font-medium text-[#2c2b6f]">Remarks</label>
                            <textarea id="remarks" rows="4" class="mt-1 block w-full rounded-md border-[#2c2b6f] shadow-sm focus:border-[#e13a27] focus:ring-[#e13a27] text-[#2c2b6f]"></textarea>
                        </div>
                        <button type="submit" class="bg-[#e13a27] text-white px-4 py-2 rounded hover:bg-[#c93022] transition">Save Receipt</button>
                    </form>
                </div>
            </div>
        </section>

        
        <section>
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-[#2c2b6f]">Receipt Gallery</h2>
                <div class="flex gap-2">
                    <input type="text" id="searchInput" placeholder="Search receipts..." class="rounded-md border-[#2c2b6f] shadow-sm focus:border-[#e13a27] focus:ring-[#e13a27] text-[#2c2b6f]">
                    <button id="exportJson" class="bg-[#2c2b6f] text-white px-4 py-2 rounded hover:bg-[#1e1e4f] transition">Export JSON</button>
                    <button id="exportPdf" class="bg-[#2c2b6f] text-white px-4 py-2 rounded hover:bg-[#1e1e4f] transition">Export PDF</button>
                </div>
            </div>
            <div id="receiptGallery" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </section>
    </main>

    <div id="toast" class="fixed bottom-4 right-4 text-white px-4 py-2 rounded shadow-lg hidden"></div>

    <script>
        const { jsPDF } = window.jspdf;

        // Load receipts from localStorage
        let receipts = JSON.parse(localStorage.getItem('receipts')) || [];

        // Initialize elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const cameraButton = document.getElementById('cameraButton');
        const imagePreview = document.getElementById('imagePreview');
        const receiptForm = document.getElementById('receiptForm');
        const receiptGallery = document.getElementById('receiptGallery');
        const searchInput = document.getElementById('searchInput');
        const exportJsonButton = document.getElementById('exportJson');
        const exportPdfButton = document.getElementById('exportPdf');
        const toast = document.getElementById('toast');
        let selectedImages = [];

        // Drag and Drop
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            handleFiles(files);
        });

        dropZone.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', () => handleFiles(fileInput.files));

        // Camera Access
        cameraButton.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                const video = document.createElement('video');
                video.srcObject = stream;
                video.play();

                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white p-4 rounded-lg">
                        <video id="cameraFeed" class="w-full max-w-md"></video>
                        <div class="flex justify-center gap-2 mt-4">
                            <button id="capture" class="bg-[#e13a27] text-white px-4 py-2 rounded hover:bg-[#c93022]">Capture</button>
                            <button id="closeCamera" class="bg-[#2c2b6f] text-white px-4 py-2 rounded hover:bg-[#1e1e4f]">Close</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                const cameraFeed = document.getElementById('cameraFeed');
                cameraFeed.srcObject = stream;

                document.getElementById('capture').addEventListener('click', () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    canvas.getContext('2d').drawImage(video, 0, 0);
                    const dataUrl = canvas.toDataURL('image/jpeg');
                    selectedImages.push(dataUrl);
                    updateImagePreview();
                    stream.getTracks().forEach(track => track.stop());
                    modal.remove();
                });

                document.getElementById('closeCamera').addEventListener('click', () => {
                    stream.getTracks().forEach(track => track.stop());
                    modal.remove();
                });
            } catch (err) {
                showToast('Camera access denied or unavailable: ' + err.message);
            }
        });

        // Handle file uploads
        function handleFiles(files) {
            for (let file of files) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        selectedImages.push(e.target.result);
                        updateImagePreview();
                    };
                    reader.readAsDataURL(file);
                } else {
                    showToast('Only image files are allowed.');
                }
            }
        }

        // Update image preview
        function updateImagePreview() {
            imagePreview.innerHTML = '';
            selectedImages.forEach((src, index) => {
                const img = document.createElement('img');
                img.src = src;
                img.className = 'w-24 h-24 object-contain rounded border border-[#2c2b6f]';
                imagePreview.appendChild(img);
            });
        }

        // Form submission
        receiptForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (selectedImages.length === 0) {
                showToast('Please upload at least one image for the receipt.');
                return;
            }

            const receipt = {
                id: Date.now(),
                title: document.getElementById('title').value,
                date: document.getElementById('date').value,
                category: document.getElementById('category').value,
                remarks: document.getElementById('remarks').value,
                images: [...selectedImages],
                verified: false
            };

            // Check if editing an existing receipt
            const existingIndex = receipts.findIndex(r => r.id === receipt.id);
            if (existingIndex !== -1) {
                receipts[existingIndex] = receipt;
            } else {
                receipts.push(receipt);
            }

            localStorage.setItem('receipts', JSON.stringify(receipts));
            selectedImages = [];
            imagePreview.innerHTML = '';
            receiptForm.reset();
            renderReceipts();
            showToast('Receipt saved successfully!');
        });

        // Render receipts
        function renderReceipts(filter = '') {
            receiptGallery.innerHTML = '';
            const filteredReceipts = receipts.filter(r =>
                r.title.toLowerCase().includes(filter.toLowerCase()) ||
                r.category.toLowerCase().includes(filter.toLowerCase()) ||
                (r.remarks && r.remarks.toLowerCase().includes(filter.toLowerCase()))
            );
            filteredReceipts.sort((a, b) => new Date(b.date) - new Date(a.date));
            filteredReceipts.forEach(receipt => {
                const card = document.createElement('div');
                card.className = 'receipt-card bg-white rounded-lg p-4 shadow relative';
                card.innerHTML = `
                    <div class="flex flex-col gap-2">
                        ${receipt.images.map(src => `<img src="${src}" class="w-full h-48 object-contain rounded border border-[#2c2b6f]">`).join('')}
                        <h3 class="text-lg font-semibold text-[#2c2b6f]">${receipt.title}</h3>
                        <p class="text-sm text-[#2c2b6f]">${receipt.date}</p>
                        <p class="text-sm text-[#2c2b6f]">${receipt.category}</p>
                        <p class="text-sm text-[#2c2b6f]">${receipt.remarks ? receipt.remarks.slice(0, 100) + (receipt.remarks.length > 100 ? '...' : '') : ''}</p>
                        ${receipt.verified ? '<span class="absolute top-2 right-2 bg-[#e13a27] text-white px-2 py-1 rounded text-xs">Verified</span>' : ''}
                        <div class="flex gap-2 mt-2">
                            <button onclick="editReceipt(${receipt.id})" class="bg-[#2c2b6f] text-white px-3 py-1 rounded hover:bg-[#1e1e4f]">Edit</button>
                            <button onclick="deleteReceipt(${receipt.id})" class="bg-[#e13a27] text-white px-3 py-1 rounded hover:bg-[#c93022]">Delete</button>
                            <button onclick="toggleVerify(${receipt.id})" class="bg-[#2c2b6f] text-white px-3 py-1 rounded hover:bg-[#1e1e4f]">${receipt.verified ? 'Unverify' : 'Verify'}</button>
                        </div>
                    </div>
                `;
                receiptGallery.appendChild(card);
            });
        }

        // Edit receipt
        window.editReceipt = (id) => {
            const receipt = receipts.find(r => r.id === id);
            if (receipt) {
                document.getElementById('title').value = receipt.title;
                document.getElementById('date').value = receipt.date;
                document.getElementById('category').value = receipt.category;
                document.getElementById('remarks').value = receipt.remarks || '';
                selectedImages = [...receipt.images];
                updateImagePreview();
                showToast('Receipt loaded for editing. Re-save to apply changes.');
            }
        };

        // Delete receipt
        window.deleteReceipt = (id) => {
            if (confirm('Are you sure you want to delete this receipt?')) {
                receipts = receipts.filter(r => r.id !== id);
                localStorage.setItem('receipts', JSON.stringify(receipts));
                renderReceipts(searchInput.value);
                showToast('Receipt deleted successfully!');
            }
        };

        // Toggle verify
        window.toggleVerify = (id) => {
            receipts = receipts.map(r => r.id === id ? { ...r, verified: !r.verified } : r);
            localStorage.setItem('receipts', JSON.stringify(receipts));
            renderReceipts(searchInput.value);
            showToast('Receipt verification status updated!');
        };

        // Search
        searchInput.addEventListener('input', () => renderReceipts(searchInput.value));

        // Export JSON
        exportJsonButton.addEventListener('click', () => {
            const dataStr = JSON.stringify(receipts, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'pgc_receipts.json';
            a.click();
            URL.revokeObjectURL(url);
            showToast('Receipts exported as JSON!');
        });

        // Export PDF
        exportPdfButton.addEventListener('click', async () => {
            const doc = new jsPDF();
            doc.setFontSize(20);
            doc.setTextColor('#2c2b6f');
            doc.text('PGC Receipt Report', 20, 20);
            let y = 30;
            const pageHeight = doc.internal.pageSize.getHeight();
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 20;

            for (const receipt of receipts) {
                const requiredSpaceForMetadata = 50;
                const estimatedImageHeight = (pageWidth - 2 * margin) * 0.5;

                if (y + requiredSpaceForMetadata + estimatedImageHeight + 20 > pageHeight) {
                    doc.addPage();
                    y = margin;
                }

                doc.setFontSize(12);
                doc.setTextColor('#2c2b6f');
                doc.text(`Title: ${receipt.title}`, margin, y);
                doc.text(`Date: ${receipt.date}`, margin, y + 10);
                doc.text(`Category: ${receipt.category}`, margin, y + 20);
                doc.text(`Remarks: ${receipt.remarks ? receipt.remarks.slice(0, 70) + (receipt.remarks.length > 70 ? '...' : '') : ''}`, margin, y + 30);
                doc.text(`Verified: ${receipt.verified ? 'Yes' : 'No'}`, margin, y + 40);
                y += 50;

                for (const imgSrc of receipt.images) {
                    if (imgSrc) {
                        const img = new Image();
                        img.src = imgSrc;
                        await new Promise(resolve => {
                            img.onload = resolve;
                            img.onerror = () => {
                                console.error("Image loading failed:", imgSrc);
                                resolve();
                            };
                        });

                        let imgWidth = pageWidth - 2 * margin;
                        let imgHeight = (img.height * imgWidth) / img.width;

                        if (imgHeight > pageHeight - y - margin) {
                            imgHeight = pageHeight - y - margin;
                            imgWidth = (img.width * imgHeight) / img.height;
                        }

                        if (y + imgHeight + 10 > pageHeight) {
                            doc.addPage();
                            y = margin;
                        }
                        try {
                            doc.addImage(imgSrc, 'JPEG', margin, y, imgWidth, imgHeight);
                            y += imgHeight + 10;
                        } catch (e) {
                            console.error("Error adding image to PDF:", e);
                        }
                    }
                }
                y += 10;
            }
            doc.save('pgc_receipts_report.pdf');
            showToast('Receipts exported as PDF!');
        });

        // Show toast
        function showToast(message) {
            toast.textContent = message;
            toast.classList.remove('hidden');
            toast.classList.add('toast');
            setTimeout(() => {
                toast.classList.add('hidden');
                toast.classList.remove('toast');
            }, 3000);
        }

        // Initial render
        renderReceipts();
    </script>
</body>
</html>